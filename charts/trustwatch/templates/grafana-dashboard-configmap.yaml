{{- if .Values.grafanaDashboard.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "trustwatch.fullname" . }}-grafana-dashboard
  labels:
    {{- include "trustwatch.labels" . | nindent 4 }}
    {{- range $key, $value := .Values.grafanaDashboard.labels }}
    {{ $key }}: {{ $value | quote }}
    {{- end }}
  {{- if or .Values.grafanaDashboard.annotations .Values.grafanaDashboard.folder }}
  annotations:
    {{- with .Values.grafanaDashboard.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    {{- if .Values.grafanaDashboard.folder }}
    grafana_folder: {{ .Values.grafanaDashboard.folder | quote }}
    {{- end }}
  {{- end }}
data:
  trustwatch.json: |
    {
      "annotations": { "list": [] },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 1,
      "schemaVersion": 39,
      "tags": ["trustwatch", "certificates", "tls"],
      "templating": {
        "list": [
          {
            "current": { "selected": false, "text": "default", "value": "default" },
            "hide": 0,
            "includeAll": false,
            "label": "Datasource",
            "name": "DS_PROMETHEUS",
            "options": [],
            "query": "prometheus",
            "refresh": 1,
            "type": "datasource"
          }
        ]
      },
      "time": { "from": "now-24h", "to": "now" },
      "title": "trustwatch",
      "uid": "trustwatch",
      "panels": [
        {
          "title": "Certificate Expiry Timeline",
          "description": "Days remaining until each certificate expires",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "fieldConfig": {
            "defaults": {
              "unit": "s",
              "custom": { "drawStyle": "line", "lineWidth": 1, "fillOpacity": 10, "pointSize": 5 },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "red", "value": null },
                  { "color": "red", "value": 0 },
                  { "color": "orange", "value": 1209600 },
                  { "color": "green", "value": 2592000 }
                ]
              },
              "color": { "mode": "thresholds" }
            },
            "overrides": []
          },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
              "expr": "trustwatch_cert_expires_in_seconds",
              "legendFormat": "{{`{{namespace}}`}}/{{`{{name}}`}}",
              "refId": "A"
            }
          ],
          "options": { "tooltip": { "mode": "multi" }, "legend": { "displayMode": "table", "placement": "right" } }
        },
        {
          "title": "Findings by Severity",
          "description": "Current count of findings grouped by severity level",
          "type": "stat",
          "gridPos": { "h": 8, "w": 6, "x": 12, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "orange", "value": 1 },
                  { "color": "red", "value": 5 }
                ]
              },
              "color": { "mode": "thresholds" }
            },
            "overrides": []
          },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
              "expr": "trustwatch_findings_total",
              "legendFormat": "{{`{{severity}}`}}",
              "refId": "A"
            }
          ],
          "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "graphMode": "none", "textMode": "auto" }
        },
        {
          "title": "Probe Success Rate",
          "description": "Percentage of successful TLS probes",
          "type": "stat",
          "gridPos": { "h": 8, "w": 6, "x": 18, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "fieldConfig": {
            "defaults": {
              "unit": "percentunit",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "red", "value": null },
                  { "color": "orange", "value": 0.9 },
                  { "color": "green", "value": 0.99 }
                ]
              },
              "color": { "mode": "thresholds" },
              "min": 0,
              "max": 1
            },
            "overrides": []
          },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
              "expr": "sum(trustwatch_probe_success) / count(trustwatch_probe_success)",
              "legendFormat": "success rate",
              "refId": "A"
            }
          ],
          "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "graphMode": "area", "textMode": "auto" }
        },
        {
          "title": "Scan Duration",
          "description": "Time taken for each discovery scan cycle",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "fieldConfig": {
            "defaults": {
              "unit": "s",
              "custom": { "drawStyle": "line", "lineWidth": 2, "fillOpacity": 20 },
              "color": { "mode": "palette-classic" }
            },
            "overrides": []
          },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
              "expr": "trustwatch_scan_duration_seconds",
              "legendFormat": "scan duration",
              "refId": "A"
            }
          ],
          "options": { "tooltip": { "mode": "single" }, "legend": { "displayMode": "list", "placement": "bottom" } }
        },
        {
          "title": "Discovery Errors by Source",
          "description": "Number of discovery errors per source type",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 8 },
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "fieldConfig": {
            "defaults": {
              "custom": { "drawStyle": "bars", "lineWidth": 1, "fillOpacity": 80 },
              "color": { "mode": "palette-classic" }
            },
            "overrides": []
          },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
              "expr": "trustwatch_discovery_errors_total",
              "legendFormat": "{{`{{source}}`}}",
              "refId": "A"
            }
          ],
          "options": { "tooltip": { "mode": "multi" }, "legend": { "displayMode": "list", "placement": "bottom" } }
        },
        {
          "title": "Certificates Closest to Expiry",
          "description": "Top 10 certificates with the shortest remaining validity",
          "type": "table",
          "gridPos": { "h": 8, "w": 24, "x": 0, "y": 16 },
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "fieldConfig": {
            "defaults": {},
            "overrides": [
              { "matcher": { "id": "byName", "options": "Value" }, "properties": [{ "id": "unit", "value": "s" }, { "id": "displayName", "value": "Expires In" }] },
              { "matcher": { "id": "byName", "options": "namespace" }, "properties": [{ "id": "displayName", "value": "Namespace" }] },
              { "matcher": { "id": "byName", "options": "name" }, "properties": [{ "id": "displayName", "value": "Name" }] },
              { "matcher": { "id": "byName", "options": "severity" }, "properties": [{ "id": "displayName", "value": "Severity" }] },
              { "matcher": { "id": "byName", "options": "source" }, "properties": [{ "id": "displayName", "value": "Source" }] },
              { "matcher": { "id": "byName", "options": "Time" }, "properties": [{ "id": "custom.hidden", "value": true }] },
              { "matcher": { "id": "byName", "options": "__name__" }, "properties": [{ "id": "custom.hidden", "value": true }] },
              { "matcher": { "id": "byName", "options": "instance" }, "properties": [{ "id": "custom.hidden", "value": true }] },
              { "matcher": { "id": "byName", "options": "job" }, "properties": [{ "id": "custom.hidden", "value": true }] }
            ]
          },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
              "expr": "topk(10, trustwatch_cert_expires_in_seconds)",
              "legendFormat": "",
              "refId": "A",
              "instant": true,
              "format": "table"
            }
          ],
          "transformations": [
            { "id": "sortBy", "options": { "sort": [{ "field": "Value", "desc": false }] } }
          ],
          "options": { "showHeader": true, "footer": { "show": false } }
        }
      ]
    }
{{- end }}
